<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="es"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>SpringBeanInjector.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">SpringConfigurer</a> &gt; <a href="index.source.html" class="el_package">com.mobiground.configuration.factory.impl</a> &gt; <span class="el_source">SpringBeanInjector.java</span></div><h1>SpringBeanInjector.java</h1><pre class="source lang-java linenums">package com.mobiground.configuration.factory.impl;

import java.lang.reflect.InvocationTargetException;
import java.lang.reflect.Method;
import java.lang.reflect.Modifier;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.Iterator;
import java.util.List;
import java.util.Map;

import org.apache.commons.collections.IteratorUtils;
import org.apache.commons.lang3.StringUtils;
import org.springframework.beans.factory.support.DefaultListableBeanFactory;
import org.springframework.context.ApplicationContext;
import org.springframework.context.ConfigurableApplicationContext;

import com.mobiground.configuration.factory.BeanInjector;
import com.mobiground.configuration.factory.bean.Dependency;
import com.mobiground.configuration.factory.bean.MobiBeanDefinition;
import com.mobiground.ecap.configuration.Configuration;
import com.mobiground.ecap.exception.configuration.MobiSpringBean;
import com.mobiground.ecap.util.string.UString;

/**
 * The Class SpringBeanInjector.
 */
<span class="fc" id="L28">public class SpringBeanInjector implements BeanInjector {</span>

	/*
	 * (non-Javadoc)
	 * 
	 * @see com.mobiground.configuration.factory.BeanInjector#injectBeans(org.springframework.context.
	 * ConfigurableApplicationContext, com.mobiground.ecap.configuration.Configuration)
	 */
	@Override
	@Deprecated
	public &lt;CONFIG_CLASS extends Configuration&gt; void injectBeans(final ConfigurableApplicationContext context,
			final CONFIG_CLASS configurationInstance) {
<span class="nc" id="L40">		List&lt;MobiSpringBean&gt; beans = null;</span>
<span class="nc" id="L41">		fillBeans(configurationInstance, beans);</span>
<span class="nc" id="L42">		addBeansToContext(context, beans);</span>
<span class="nc" id="L43">	}</span>

	/*
	 * (non-Javadoc)
	 * 
	 * @see com.mobiground.configuration.factory.BeanInjector#getBeanDefinition(com.mobiground.ecap.configuration.
	 * Configuration)
	 */
	@Override
	public &lt;CONFIG_CLASS extends Configuration&gt; List&lt;MobiBeanDefinition&gt; getBeanDefinition(
			final CONFIG_CLASS configurationInstance) {
<span class="fc" id="L54">		List&lt;MobiBeanDefinition&gt; beanDefinitions = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L55">		Iterator&lt;Method&gt; toBeRegisterdBeanIterator = getAllBeanToBeRegistered(configurationInstance);</span>
<span class="fc bfc" id="L56" title="All 2 branches covered.">		while (toBeRegisterdBeanIterator.hasNext()) {</span>
<span class="fc" id="L57">			Method toBeInjectedBen = (Method) toBeRegisterdBeanIterator.next();</span>
<span class="fc bfc" id="L58" title="All 2 branches covered.">			if (isValidBean(toBeInjectedBen)) {</span>
<span class="fc" id="L59">				beanDefinitions.add(getBeanDefinition(configurationInstance, toBeInjectedBen));</span>
			}
<span class="fc" id="L61">		}</span>
<span class="fc" id="L62">		return beanDefinitions;</span>
	}

	/*
	 * (non-Javadoc)
	 * 
	 * @see com.mobiground.configuration.factory.BeanInjector#addDependencies(com.mobiground.configuration.factory.bean.
	 * MobiBeanDefinition, org.springframework.context.ApplicationContext)
	 */
	@Override
	public MobiBeanDefinition addDependencies(final MobiBeanDefinition beanDefinition,
			final ApplicationContext context) {
<span class="fc" id="L74">		Iterator&lt;Dependency&gt; iteratorDependencies = beanDefinition.getDependencies().iterator();</span>
<span class="fc bfc" id="L75" title="All 2 branches covered.">		while (iteratorDependencies.hasNext()) {</span>
<span class="fc" id="L76">			Dependency dependency = (Dependency) iteratorDependencies.next();</span>
<span class="fc bfc" id="L77" title="All 2 branches covered.">			beanDefinition.addCdiBeans(ApplicationContext.class.isAssignableFrom(dependency.getClazz()) ? context</span>
					: getBeanFrom(dependency, context, beanDefinition.getConfiguration().getConfigName()));
<span class="fc" id="L79">		}</span>
<span class="fc" id="L80">		return beanDefinition;</span>
	}

	/**
	 * Gets the bean from.
	 *
	 * @param dependency the dependency
	 * @param context the context
	 * @param prefix the prefix
	 * @return the bean from
	 */
	private Object getBeanFrom(final Dependency dependency, final ApplicationContext context, final String prefix) {
<span class="fc" id="L92">		Object bean = null;</span>
<span class="pc bpc" id="L93" title="1 of 2 branches missed.">		if (!context.containsBean(dependency.getBeanName())) {</span>
<span class="fc" id="L94">			Map&lt;String, Object&gt; beans = (Map&lt;String, Object&gt;) context.getBeansOfType(dependency.getClazz());</span>
<span class="fc" id="L95">			String[] keySet = beans.keySet().toArray(new String[] {});</span>
<span class="fc" id="L96">			String beanKey = keySet[0];</span>
<span class="fc bfc" id="L97" title="All 2 branches covered.">			if (beans.keySet().size() &gt; 1) {</span>
<span class="fc" id="L98">				bean = setByPrefix(prefix, beans, keySet, beanKey);</span>
			} else {
<span class="fc" id="L100">				bean = beans.get(beanKey);</span>
			}
<span class="fc" id="L102">		} else {</span>
<span class="nc" id="L103">			bean = context.getBean(dependency.getBeanName());</span>
		}

<span class="fc" id="L106">		return bean;</span>
	}

	/**
	 * Sets the by prefix.
	 *
	 * @param prefix the prefix
	 * @param beans the beans
	 * @param keySet the key set
	 * @param beanKey the bean key
	 * @return the object
	 */
	private Object setByPrefix(final String prefix, final Map&lt;String, Object&gt; beans, final String[] keySet,
			final String beanKey) {
<span class="fc" id="L120">		Object bean = null;</span>
<span class="pc bpc" id="L121" title="1 of 2 branches missed.">		if (UString.isEmpty(prefix)) {</span>
<span class="fc" id="L122">			bean = beans.get(checkAllBeanNames(keySet, beanKey));</span>
		} else {
<span class="nc" id="L124">			bean = checkAllBeansPrefix(prefix, beans, keySet, beanKey);</span>
		}
<span class="fc" id="L126">		return bean;</span>
	}

	/**
	 * Check all beans prefix.
	 *
	 * @param prefix the prefix
	 * @param beans the beans
	 * @param keySet the key set
	 * @param beanKey the bean key
	 * @return the object
	 */
	private Object checkAllBeansPrefix(final String prefix, final Map&lt;String, Object&gt; beans, final String[] keySet,
			final String beanKey) {
<span class="nc" id="L140">		Object bean = null;</span>
<span class="nc bnc" id="L141" title="All 2 branches missed.">		for (String key : keySet) {</span>
<span class="nc bnc" id="L142" title="All 2 branches missed.">			if (isSamePrefix(prefix, key)) {</span>
<span class="nc" id="L143">				bean = beans.get(beanKey);</span>
			}
		}
<span class="nc" id="L146">		return bean;</span>
	}

	/**
	 * Checks if is same prefix.
	 *
	 * @param prefix the prefix
	 * @param key the key
	 * @return true, if is same prefix
	 */
	private boolean isSamePrefix(final String prefix, final String key) {
<span class="nc" id="L157">		return StringUtils.startsWith(key, prefix);</span>
	}

	/**
	 * Check all bean names.
	 *
	 * @param keySet the key set
	 * @param beanKey the bean key
	 * @return the string
	 */
	private String checkAllBeanNames(final String[] keySet, final String beanKey) {
<span class="fc" id="L168">		String key = beanKey;</span>
<span class="fc bfc" id="L169" title="All 2 branches covered.">		for (int i = 1; i &lt; keySet.length; i++) {</span>
<span class="fc" id="L170">			key = overriveBeanName(keySet, beanKey, i);</span>
		}
<span class="fc" id="L172">		return key;</span>
	}

	/**
	 * Overrive bean name.
	 *
	 * @param keySet the key set
	 * @param beanKey the bean key
	 * @param i the i
	 * @return the string
	 */
	private String overriveBeanName(final String[] keySet, final String beanKey, final int i) {
<span class="fc" id="L184">		String key = beanKey;</span>
<span class="pc bpc" id="L185" title="1 of 2 branches missed.">		if (isShorterThan(keySet[i], beanKey)) {</span>
<span class="fc" id="L186">			key = keySet[i];</span>
		}
<span class="fc" id="L188">		return key;</span>
	}

	/**
	 * Checks if is shorter than.
	 *
	 * @param keySet the key set
	 * @param beanKey the bean key
	 * @return true, if is shorter than
	 */
	private boolean isShorterThan(final String keySet, final String beanKey) {
<span class="pc bpc" id="L199" title="1 of 2 branches missed.">		return keySet.length() &lt; beanKey.length();</span>
	}

	/**
	 * Adds the beans to context.
	 *
	 * @param context the context
	 * @param beans the beans
	 */
	private static void addBeansToContext(final ConfigurableApplicationContext context,
			final List&lt;MobiSpringBean&gt; beans) {
<span class="nc" id="L210">		DefaultListableBeanFactory factory = (DefaultListableBeanFactory) context.getBeanFactory();</span>
<span class="nc bnc" id="L211" title="All 2 branches missed.">		for (MobiSpringBean mobiSpringBean : beans) {</span>
<span class="nc" id="L212">			factory.registerSingleton(mobiSpringBean.getName(), mobiSpringBean.getBean());</span>

<span class="nc" id="L214">		}</span>
<span class="nc" id="L215">	}</span>

	/**
	 * Fill beans.
	 *
	 * @param &lt;CONFIG_CLASS&gt; the generic type
	 * @param configurationInstance the configuration instance
	 * @param beans the beans
	 */
	private static &lt;CONFIG_CLASS extends Configuration&gt; void fillBeans(final CONFIG_CLASS configurationInstance,
			final List&lt;MobiSpringBean&gt; beans) {
<span class="nc" id="L226">		Iterator&lt;Method&gt; toBeRegisterdBeanIterator = getAllBeanToBeRegistered(configurationInstance);</span>
<span class="nc bnc" id="L227" title="All 2 branches missed.">		while (toBeRegisterdBeanIterator.hasNext()) {</span>
<span class="nc" id="L228">			Method toBeInjectedBen = (Method) toBeRegisterdBeanIterator.next();</span>
<span class="nc" id="L229">			fillBean(configurationInstance, configurationInstance.getConfigName(), beans, toBeInjectedBen);</span>
<span class="nc" id="L230">		}</span>
<span class="nc" id="L231">	}</span>

	/**
	 * Gets the all bean to be registered.
	 *
	 * @param &lt;T&gt; the generic type
	 * @param configurationInstance the configuration instance
	 * @return the all bean to be registered
	 */
	private static &lt;T&gt; Iterator&lt;Method&gt; getAllBeanToBeRegistered(final T configurationInstance) {
<span class="fc" id="L241">		Method[] toBeRegistered = configurationInstance.getClass().getDeclaredMethods();</span>
<span class="fc" id="L242">		List&lt;Method&gt; methodList = Arrays.asList(toBeRegistered);</span>
<span class="fc" id="L243">		Iterator&lt;Method&gt; methodIterator = methodList.iterator();</span>
<span class="fc" id="L244">		return methodIterator;</span>
	}

	/**
	 * Fill bean.
	 *
	 * @param &lt;T&gt; the generic type
	 * @param configurationInstance the configuration instance
	 * @param prefix the prefix
	 * @param beans the beans
	 * @param toBeInjectedBen the to be injected ben
	 */
	private static &lt;T&gt; void fillBean(final T configurationInstance, final String prefix,
			final List&lt;MobiSpringBean&gt; beans, final Method toBeInjectedBen) {
		try {
<span class="nc bnc" id="L259" title="All 2 branches missed.">			if (isValidBean(toBeInjectedBen)) {</span>
<span class="nc" id="L260">				MobiSpringBean mobiSpringBean = fillMobiSpringBean(configurationInstance, prefix, toBeInjectedBen);</span>
<span class="nc" id="L261">				beans.add(mobiSpringBean);</span>
			}
<span class="nc" id="L263">		} catch (IllegalAccessException | IllegalArgumentException | InvocationTargetException e) {</span>
<span class="nc" id="L264">			e.printStackTrace();</span>
<span class="nc" id="L265">		}</span>
<span class="nc" id="L266">	}</span>

	/**
	 * Fill mobi spring bean.
	 *
	 * @param &lt;T&gt; the generic type
	 * @param configurationInstance the configuration instance
	 * @param prefix the prefix
	 * @param method the method
	 * @return the mobi spring bean
	 * @throws IllegalAccessException the illegal access exception
	 * @throws InvocationTargetException the invocation target exception
	 */
	private static &lt;T&gt; MobiSpringBean fillMobiSpringBean(final T configurationInstance, final String prefix,
			final Method method) throws IllegalAccessException, InvocationTargetException {
		MobiSpringBean mobiSpringBean;
<span class="nc" id="L282">		mobiSpringBean = new MobiSpringBean();</span>
<span class="nc" id="L283">		mobiSpringBean.setBean(method.invoke(configurationInstance));</span>
<span class="nc" id="L284">		mobiSpringBean.setName(createBeanName(prefix, mobiSpringBean));</span>
<span class="nc" id="L285">		return mobiSpringBean;</span>
	}

	/**
	 * Gets the bean definition.
	 *
	 * @param &lt;CONFIG_CLASS&gt; the generic type
	 * @param configurationInstance the configuration instance
	 * @param method the method
	 * @return the bean definition
	 */
	private &lt;CONFIG_CLASS extends Configuration&gt; MobiBeanDefinition getBeanDefinition(
			final CONFIG_CLASS configurationInstance, final Method method) {
<span class="fc" id="L298">		Class&lt;?&gt; clazz = method.getReturnType();</span>
<span class="fc" id="L299">		MobiBeanDefinition beanDefinition = new MobiBeanDefinition(clazz, configurationInstance);</span>
<span class="fc" id="L300">		beanDefinition.setBeanName(beanName(configurationInstance.getConfigName(), clazz));</span>
<span class="fc" id="L301">		beanDefinition.setFactoryMethod(method);</span>
<span class="fc" id="L302">		getDependencyBeans(configurationInstance.getConfigName(), method.getParameterTypes(), beanDefinition);</span>
<span class="fc" id="L303">		return beanDefinition;</span>
	}

	/**
	 * Gets the dependency beans.
	 *
	 * @param prefix the prefix
	 * @param factoryMethodParams the factory method params
	 * @param beanDefinition the bean definition
	 */
	private void getDependencyBeans(final String prefix, final Class&lt;?&gt;[] factoryMethodParams,
			final MobiBeanDefinition beanDefinition) {
<span class="fc" id="L315">		Iterator&lt;Class&lt;?&gt;&gt; iterator = IteratorUtils.arrayIterator(factoryMethodParams);</span>
<span class="fc bfc" id="L316" title="All 2 branches covered.">		while (iterator.hasNext()) {</span>
<span class="fc" id="L317">			Class&lt;?&gt; clazz = (Class&lt;?&gt;) iterator.next();</span>
<span class="fc" id="L318">			Dependency dependency = new Dependency();</span>
<span class="fc" id="L319">			dependency.setClazz(clazz);</span>
<span class="fc" id="L320">			dependency.setBeanName(beanName(prefix, clazz));</span>
<span class="fc" id="L321">			beanDefinition.addDependency(dependency);</span>
<span class="fc" id="L322">		}</span>

<span class="fc" id="L324">	}</span>

	/**
	 * Bean name.
	 *
	 * @param prefix the prefix
	 * @param clazz the clazz
	 * @return the string
	 */
	private String beanName(final String prefix, final Class&lt;?&gt; clazz) {
<span class="fc bfc" id="L334" title="All 2 branches covered.">		return UString.join(prefix,</span>
			UString.isEmpty(prefix) ? UString.uncapitalize(clazz.getSimpleName()) : clazz.getSimpleName());
	}

	/**
	 * Checks if is valid bean.
	 *
	 * @param toBeInjectedBean the to be injected bean
	 * @return true, if is valid bean
	 */
	private static boolean isValidBean(final Method toBeInjectedBean) {
<span class="fc bfc" id="L345" title="All 6 branches covered.">		return !toBeInjectedBean.isSynthetic() &amp;&amp; !Modifier.isPrivate(toBeInjectedBean.getModifiers())</span>
				&amp;&amp; Object.class.isAssignableFrom(toBeInjectedBean.getReturnType());
	}

	/**
	 * Creates the bean name.
	 *
	 * @param prefix the prefix
	 * @param mobiSpringBean the mobi spring bean
	 * @return the string
	 */
	private static String createBeanName(final String prefix, final MobiSpringBean mobiSpringBean) {
<span class="nc" id="L357">		String beanName = mobiSpringBean.getBean().getClass().getSimpleName();</span>
<span class="nc bnc" id="L358" title="All 2 branches missed.">		return UString.isEmpty(prefix) ? UString.uncapitalize(beanName) : UString.join(prefix, beanName);</span>
	}

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.1.201405082137</span></div></body></html>